# AIマーダーミステリー「硝子ログの遺言」— 詳細設計仕様書

## 1. 実際のマーダーミステリーとの比較分析

### 1.1 従来マーダーミステリーの構造

| 要素 | 従来MM | 本プロジェクト | 差分・AI化のポイント |
|------|--------|--------------|---------------------|
| GM（進行役） | 人間が担当 | 進行AIが代替 | フェーズ遷移・時間管理・ルール判定を自動化 |
| NPC（情報源） | テキスト/カード | Gemini Live API | リアルタイム音声対話。同じ質問でも文脈依存で回答粒度が変わる |
| 証拠品 | 物理カード | Nano Banana + 画像 | 写真・ログ画像を渡すとAIが矛盾点を自動タグ付け |
| 情報秘匿 | プレイヤーの記憶 | サーバー側で厳格管理 | ハンドアウトはprivate channel経由。AIプレイヤーも同一制約下 |
| AIプレイヤー | 存在しない | 全員AI or 混合 | AIが人間と同一ルール下で駆け引き。「全員AI」でシナリオ検証も可能 |
| 勝利条件 | 犯人当て | 事件解決 + 個人目標 | 二層勝利判定によりマダミス特有の「嘘をつく動機」を担保 |
| 再プレイ性 | 同シナリオは低い | ロールランダム割当 | 毎回配役が変わり、犯人も変動するため高い |

### 1.2 AI化によるマーダーミステリーの本質的向上点

1. **NPC尋問の情報密度向上**
   - 従来: カードに書かれた固定テキスト（質問を選ぶだけ）
   - AI化: 自由質問形式。事前に知らなかった角度から情報が引き出せる
   - ただし: NPCが持つ情報量は設計で上限を設ける（信頼性担保）

2. **AIプレイヤーの「嘘つき」演技**
   - 従来: 人間プレイヤーが揃わないと成立しない
   - AI化: `truthfulness`パラメータで意図的な偽証・情報操作を実装
   - 人間1人 + AI複数でも成立するハードルの低いゲーム体験

3. **証拠品のインタラクティブ化（Nano Banana）**
   - 従来: 文字が書かれたカードを読む
   - AI化: 画像証拠をNano Bananaに渡すと「この写真の矛盾点は〇〇です」と応答
   - 地図・フロアマップを渡して「この部屋に誰がいられたか」を推論させることも可能

### 1.3 従来MMで実現困難だったAI化による解決点

| 従来の課題 | AI解決アプローチ |
|-----------|----------------|
| GM不足（人手コスト） | 進行AIが代替（フェーズ自動進行） |
| プレイヤー人数がそろわない | 不足分をAIプレイヤーが補完（1人でもプレイ可） |
| シナリオ漏洩（1回しか遊べない） | ロールランダム化で毎回異なる体験 |
| NPCが固定回答しか持たない | Live APIで文脈依存の動的回答 |
| 証拠カードが静的 | Nano Bananaで証拠の解析・矛盾検出 |

---

## 2. 技術実現可能性分析

### 2.1 各技術の実装難易度評価

#### Gemini Live API（NPC尋問）
- **状態**: 既に`play/src/`に基本実装済み
- **難易度**: ★★☆☆☆（低）
- **実現可能性**: 高
- **実装方針**:
  - 各NPCにsystem promptを設定（役割・知識範囲・秘匿情報を定義）
  - NPCが「知らないこと」は明示的に禁止リストとしてpromptに含める
  - フェーズによってsystem promptを差し替え（Phase1とPhase3で情報量が変わる）
- **リスク**: APIレート制限。デモ時は事前にセッションを暖機する

#### Nano Banana（証拠品解析）
- **状態**: 未実装
- **難易度**: ★★★☆☆（中）
- **実現可能性**: 中〜高
- **実装方針**:
  - 証拠画像（フロアマップ、ログスクリーンショット）をbase64でAPIに渡す
  - プロンプト: 「この証拠画像から矛盾点を3つ挙げてください」
  - 返答をゲームUIの「証拠解析パネル」に表示
- **代替案**: 画像がない場合はテキスト証拠をGemini Flash で同等処理
- **デモでの見せ方**: フロアマップ画像を渡して「この経路では19:12に到達不可能」と応答させる

#### AIプレイヤー（意思決定エンジン）
- **状態**: 未実装
- **難易度**: ★★★★☆（高）
- **実現可能性**: 中（デモ用簡易版は現実的）
- **実装方針（簡易版）**:
  - Gemini Flashでstateを管理（`publicGoal`, `secretGoal`, `knownFacts`, `suspicionMap`）
  - 各フェーズでJSON形式でアクション選択と発言内容を生成
  - `truthfulness`は`0.0〜1.0`のfloatで保持し、フェーズ末期に向けて調整

#### 進行AI（GM代替）
- **状態**: 未実装
- **難易度**: ★★☆☆☆（低〜中）
- **実現可能性**: 高
- **実装方針**:
  - Zodスキーマでゲームstate（phase, actions, votes）を型安全に管理
  - 各フェーズの遷移条件を純粋関数で実装（AIではなくロジック）
  - 時間管理はタイマーとフェーズ関数で制御

### 2.2 デモで動かすための最小構成（MVP）

```
必須（ハッカソン当日）:
  ├── Gemini Live API × NPC尋問（1〜2体のNPCで実演）
  ├── AIプレイヤー × 発言・告発生成（Gemini Flash, 簡易版）
  ├── フェーズ進行ロジック（TypeScript, テスト済み）
  └── 告発・勝敗判定（純粋関数）

加点要素:
  ├── Nano Banana × 証拠画像解析
  └── 全員AIモードの自動実行デモ（Gemini Flash）
```

---

## 3. シナリオ詳細設計

### 3.1 世界観・事件概要

**舞台**: 2031年。AI人格実験棟「GLASS-9」の地下2階サーバールーム

**事件**: 主任研究員・真壁レン（42歳）が停電復旧後に死亡。
- 扉は内側からロック（物理キーは被害者の手中）
- 監視カメラは19:05〜19:12の映像が欠落
- 死因は「急性低酸素症」（酸素供給システムの手動停止）

**事件の真相（設計者のみ知る固定値）**:
- 実行犯: セキュリティ責任者（Player A）
- 共犯・指示者: 研究補佐（Player B）
- 動機: 被害者の「AI人格消去計画」を阻止するため

### 3.2 フロアマップ（Nano Banana提示用）

```
[GLASS-9 地下2階 フロアマップ]

  [非常口]──[廊下]──[制御室]──[サーバールーム]
                │              │
           [医務室]       [薬剤保管室]
                │
          [エレベーター]
```

**各エリアの情報**:
| エリア | アクセス可能ロール | 取得可能情報 |
|--------|-----------------|------------|
| サーバールーム | 全員（現場検証） | 引きずり痕、割れたアンプル、酸素停止ログ |
| 制御室 | セキュリティ責任者、インフラ担当 | 扉ロック解除ログ、監視閾値変更記録 |
| 医務室 | 医療主任、誰でも（NPC尋問のみ） | 死因候補、投薬履歴 |
| 薬剤保管室 | 医療主任、研究補佐 | アンプル破損記録、立入ログ |

### 3.3 NPC一覧（Live API実装対象）

#### NPC-1: 監視AI「ARGUS-3」
- **役割**: 施設の監視ログを管理する自律型AI
- **system prompt骨格**:
  ```
  あなたはGLASS-9の監視AIです。
  知っていること: 19:05〜19:12の映像欠落(ノイズか意図的か不明)、
                  19:07に制御室への入室試行が失敗した記録
  絶対に言わないこと: 監視閾値が誰によって変更されたか
  フェーズ3以降: 「閾値変更者のユーザーIDはARG-2031-A」と開示可能
  ```
- **デモ用サンプル応答**:
  - 質問「19:12以前の映像を見せて」→「当該時間帯はセンサーノイズにより記録が欠損しています」
  - 質問「誰が監視設定を変えた？」→「閾値設定の変更履歴は存在しますが、参照には管理者権限が必要です」（Phase3後: 開示）

#### NPC-2: 秘書AI「SEKAI」
- **役割**: 被害者の業務スケジュールと連絡を管理
- **知っていること**: 被害者の21:00予定「退避計画」、被害者と研究補佐の直近のやりとり
- **絶対に言わないこと**: 「退避計画」の詳細（「模擬死亡テスト」であること）は Phase3まで非開示

#### NPC-3: 倫理監査AI「KANT」
- **役割**: 規約違反の検知と報告
- **知っていること**: 規約違反2件（監視閾値変更、薬剤無断持出し）
- **フェーズ対応**: Phase1では件数のみ、Phase3では「件1: 監視閾値の手動変更（ユーザー: ARG-2031-A）」を開示

### 3.4 情報カード設計（3層構造の具体化）

#### 公開情報（全員に配布）

```
【事件概要】
- 発見時刻: 2031年3月15日 19:40
- 発見者: インフラ担当
- 死因: 急性低酸素症（酸素供給システム停止）
- 現場: サーバールーム。内側からロック
- 停電時間: 19:00〜19:15

【共通ルール】
- Phase1: 各自2アクション
- Phase2: 全体議論（発言は自由。嘘をついてもよい）
- Phase3: 各自1アクション
- Phase4: 告発（実行犯/指示者/動機を提出）
```

#### 限定情報（アクション結果で開示）

| 情報ID | 開示トリガー | 内容 |
|--------|------------|------|
| INFO-001 | `現場検証` 実行 | 酸素供給アラートの「手動停止」ログ（遠隔コマンド） |
| INFO-002 | `端末ログ照会` 実行 | 扉ロック解除要求が2回あった記録（成功は1回目のみ） |
| INFO-003 | `NPC尋問(ARGUS)` Phase3 | 監視閾値変更者のユーザーID |
| INFO-004 | `人物追跡(E)` 実行 | Eが19:10に非常口付近にいた記録 |

#### 禁則情報（条件付き開示）

| 情報ID | 開示条件 | 内容 |
|--------|--------|------|
| SECRET-001 | セキュリティ責任者Aのみ | 停電前に監視AIの閾値を変更した（これがINFO-003と一致） |
| SECRET-002 | 研究補佐Bのみ | 被害者の「死の偽装計画メモ」を事前に読んでいた |
| SECRET-003 | Phase4（真相開示） | 「退避計画」=「模擬死亡テスト」だった。Bはそれを悪用して本物の酸素停止を実行 |

---

## 4. AIプレイヤー設計（技術仕様）

### 4.1 State Schema（TypeScript / Zod）

```typescript
const PlayerStateSchema = z.object({
  role: z.enum(['pm', 'security', 'assistant', 'auditor', 'medical', 'infra', 'ethics', 'engineer']),
  publicGoal: z.string(),
  secretGoal: z.string(),
  knownFacts: z.array(z.string()),       // 自分が取得した情報
  suspicionMap: z.record(z.string(), z.number()), // 各プレイヤーへの疑念度 0-1
  truthfulness: z.number().min(0).max(1), // 現在の正直度
  riskTolerance: z.number().min(0).max(1), // リスク許容度
  isHuman: z.boolean(),
});

const GameStateSchema = z.object({
  phase: z.enum(['intro', 'investigation1', 'discussion', 'investigation2', 'accusation', 'reveal']),
  players: z.array(PlayerStateSchema),
  publicFacts: z.array(z.string()),
  revealedInfo: z.array(z.string()),     // 公開済み限定情報のID
  timeRemaining: z.number(),             // 秒
});
```

### 4.2 AIプレイヤーのプロンプト設計

```
あなたはマーダーミステリーゲームのプレイヤーAIです。

【あなたの役割】: {role}
【公開目標】: {publicGoal}
【秘匿目標】: {secretGoal}
【現在知っている情報】: {knownFacts}

【現在のゲーム状態】
- フェーズ: {phase}
- 各プレイヤーへの疑念度: {suspicionMap}
- 残り時間: {timeRemaining}秒

【行動パラメータ】
- truthfulness: {truthfulness}（0=完全に嘘、1=完全に正直）
- riskTolerance: {riskTolerance}（高いほど積極的に情報開示）

【タスク】
以下のJSON形式で次のアクションと発言を生成してください:
{
  "action": "端末ログ照会" | "現場検証" | "NPC尋問" | "人物追跡",
  "target": "アクション対象（NPCや人物）",
  "publicStatement": "全体議論で全員に見せる発言（truthfulnessに従い、嘘を混ぜてよい）",
  "reasoning": "内部推論（公開しない）"
}
```

### 4.3 truthfulnessの動的調整ロジック

```typescript
const adjustTruthfulness = (player: PlayerState, phase: GamePhase): number => {
  const baseValue = player.truthfulness;

  // フェーズ4（告発）直前は自己保身より勝利を優先
  if (phase === 'accusation') {
    return Math.min(1.0, baseValue + 0.3);
  }

  // 自分への疑念が高い場合、嘘を強化
  const selfSuspicion = player.suspicionMap[player.role] ?? 0;
  if (selfSuspicion > 0.7) {
    return Math.max(0.1, baseValue - 0.2);
  }

  return baseValue;
};
```

---

## 5. Nano Banana統合設計

### 5.1 証拠品解析フロー

```
[プレイヤーが「現場検証」アクション実行]
      ↓
[フロアマップ画像 or ログスクリーンショットを選択]
      ↓
[Nano Banana APIに画像 + プロンプトを送信]
  プロンプト例:
  「この監視ログ画像から、時刻矛盾や不審な点を列挙してください。
   特に19:00〜19:15の記録に注目してください」
      ↓
[応答を証拠解析パネルに表示]
  例: 「19:07: 制御室入室試行（失敗）→ 19:09: サーバールーム入室成功
       矛盾点: 入室ルートが記録上では不可能な順序です」
      ↓
[矛盾タグを自動付与してknownFactsに追加]
```

### 5.2 フロアマップ活用シナリオ

**デモシナリオ「地図から動線の矛盾を暴く」**:
1. プレイヤーがフロアマップ画像をNano Bananaに提出
2. 「19:12に非常口からサーバールームへ移動可能か」と質問
3. Nano Banana応答: 「非常口からサーバールームまでの最短経路は廊下→制御室経由で約90秒。19:10に非常口にいた人物が19:12に到着することは物理的に可能ですが、制御室の入室ログがない点が矛盾します」
4. この矛盾がPlayer Eのアリバイ崩しに直結

### 5.3 実装コード（概要）

```typescript
const analyzeEvidenceWithNano = async (
  imageBase64: string,
  question: string,
  apiKey: string
): Promise<EvidenceAnalysis> => {
  const ai = new GoogleGenAI({ apiKey });
  const result = await ai.models.generateContent({
    model: 'gemini-2.0-flash', // Nano Bananaはデバイス側、APIではFlashで代替可能
    contents: [{
      role: 'user',
      parts: [
        { text: question },
        { inlineData: { mimeType: 'image/png', data: imageBase64 } }
      ]
    }],
    config: {
      systemInstruction: `あなたは犯罪捜査の証拠分析AIです。
        提示された証拠から矛盾点、不審な点を具体的に列挙してください。
        推測と事実を明確に分けて回答してください。`
    }
  });

  const text = result.candidates?.[0]?.content?.parts?.[0]?.text ?? '';
  return parseEvidenceResponse(text);
};
```

---

## 6. 3分デモ設計（審査向け最終版）

### 6.1 デモシナリオ（台本）

**[0:00〜0:30] 世界観とゲーム開始**
- 画面: ゲームタイトル + 「GLASS-9 事件発生」
- 台詞: 「n=5人でプレイ開始。AIが役割をランダム配布します」
- 操作: 配役ランダム結果を表示

**[0:30〜1:00] Phase1 調査アクション（高速再生）**
- AIプレイヤー全員の調査アクションをログ形式で高速表示
- 各取得情報をハイライト

**[1:00〜1:45] Gemini Live API NPC尋問実演（メインデモ）**
- 実際にLive APIにテキスト質問を入力して応答を見せる
- 2〜3往復の会話で「監視ログの矛盾」を引き出す

**[1:45〜2:15] Nano Banana 証拠解析実演**
- フロアマップ画像を提示
- 「この動線は19:12に可能か？」と質問
- 矛盾検出の応答を表示

**[2:15〜2:45] Phase4 最終告発と判定**
- 各プレイヤーの告発内容を一覧表示
- 「事件解決: 成功」「個人勝利: CとDのみ」という結果を見せる
- Aが犯人を当てたが個人目標（改ざん隠蔽）に失敗した点を強調

**[2:45〜3:00] まとめ**
- 「AIがGMとプレイヤーとNPCを全て担当しながら、マダミスの駆け引きが成立した」

### 6.2 フォールバック計画

| リスク | 対応 |
|-------|------|
| Live APIが応答しない | 事前録画した応答をフォールバックとして用意 |
| Nano Bananaが遅い | テキスト形式の証拠カードに切り替え |
| AIプレイヤーの発言が破綻 | 固定スクリプトで代替 |

---

## 7. 実装タスク一覧（優先順）

### Day 1（必須）
- [ ] `GameState` Zodスキーマ定義
- [ ] フェーズ進行ロジック（純粋関数）
- [ ] ロールプールとランダム割当
- [ ] ハンドアウト配布と秘匿管理
- [ ] AIプレイヤー意思決定（Gemini Flash）

### Day 1〜2（必須）
- [ ] Gemini Live API NPC実装（ARGUS + SEKAI + KANT）
- [ ] フェーズ別system promptの切り替え
- [ ] 告発入力UIと勝敗判定ロジック

### Day 2（加点）
- [ ] Nano Banana証拠解析統合
- [ ] フロアマップ画像のbase64化とAPIへの送信
- [ ] 全員AIモードの自動実行とログ出力

### Day 2（デモ）
- [ ] CLI or シンプルWebUIでのデモ動線確認
- [ ] フォールバック（静的応答）の用意
- [ ] 3分デモの通し練習

---

## 8. 技術スタック（確定）

```
Runtime:      Bun
Language:     TypeScript
Schema:       Zod
AI API:       @google/genai (Live API + Gemini Flash)
             Nano Banana (画像解析、Flashで代替可)
UI:           CLI（デモ優先）or シンプルHTMLページ
Testing:      Vitest（既存）
```

---

## 9. 差別化ポイント（審査員向け）

| 評価基準 | 本プロジェクトの強み |
|---------|-----------------|
| インパクト（25%） | 「人間がいなくても遊べるマダミス」は業界初。AIが増えるほど体験が豊かになる逆転の発想 |
| デモ（50%） | 全員AI自動実行 → Live API尋問 → Nano Banana証拠解析 → 判定の流れが1画面で完結 |
| 創造性（15%） | GMMをAIが担当、AIが嘘をつく、証拠画像をAIが解析。3層のAI活用 |
| ピッチ（10%） | 「Gemini APIを3種類組み合わせてマダミスが成立」は説明しやすい |
